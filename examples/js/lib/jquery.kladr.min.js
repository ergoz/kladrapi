(function(a){a.kladr={};a.kladr.url="https://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,d){var b={};if(c.token){b.token=c.token}if(c.key){b.key=c.key}if(c.type){b.contentType=c.type}if(c.name){b.query=c.name}if(c.parentType&&c.parentId){b[c.parentType+"Id"]=c.parentId}if(c.withParents){b.withParent=1}b.limit=c.limit?c.limit:2000;a.getJSON(a.kladr.url+"?callback=?",b,function(e){d&&d(e.result)})};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(b,a){b.fn.kladr=function(i,n){var v=this;var q=null;var h=null;var t=null;var e={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(B,C){var A={token:t.token,key:t.token,type:t.type,name:B,parentType:t.parentType,parentId:t.parentId,withParents:t.withParents,limit:t.limit};b.kladr.api(A,C)},labelFormat:function(D,B){var A="";var E=D.name.toLowerCase();B=B.toLowerCase();var C=E.indexOf(B);C=C>0?C:0;if(D.typeShort){A+=D.typeShort+". "}if(B.length<D.name.length){A+=D.name.substr(0,C);A+="<strong>"+D.name.substr(C,B.length)+"</strong>";A+=D.name.substr(C+B.length,D.name.length-B.length-C)}else{A+="<strong>"+D.name+"</strong>"}return A},valueFormat:function(B,A){return B.name}};var w={up:38,down:40,esc:27,enter:13};var m=null;var l=function(B,C,D){t=v.data("kladr-options");if(C!==a){t[B]=C;v.data("kladr-options",t);return v}if(b.type(B)==="string"){if(!t){return null}return t[B]}if(t){return v}t=e;if(b.type(B)==="object"){for(var A in B){t[A]=B[A]}}v.data("kladr-options",t);D&&D();return v};var u=function(D){var E="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var B="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var G="";var C;var F;for(var A=0;A<D.length;A++){C=D[A];F=E.indexOf(C);if(F>-1){G+=B[F];continue}G+=C}return G};var p=function(A,B){if(!A){return}v.trigger("kladr_"+A,B);t[A]&&t[A](B)};var d=function(){var B=b(document.getElementById("kladr_autocomplete"));var A=v.attr("name");if(!B.length){B=b('<div id="kladr_autocomplete"></div>').appendTo("body")}v.attr("autocomplete","off");q=b('<ul class="kladr_autocomplete_'+A+'" style="display: none;"></ul>');q.appendTo(B);h=b('<div class="spinner kladr_autocomplete_'+A+'_spinner" class="spinner" style="display: none;"></div>');h.appendTo(B)};var x=function(){var A=v.offset();var C=v.outerWidth();var B=v.outerHeight();q.css({top:A.top+B+"px",left:A.left});var F=q.outerWidth()-q.width();q.width(C-F);var D=h.width();var E=h.height();h.css({top:A.top+(B-E)/2-1,left:A.left+C-D-2,})};var g=function(E,G){q.empty();for(var B in E){var H=E[B];var A=t.valueFormat(H,G);var C=t.labelFormat(H,G);var D=b('<a data-val="'+A+'">'+C+"</a>");D.data("kladr-object",H);var F=b("<li></li>").append(D);F.appendTo(q)}};var s=function(){var A=q.find(".active a");if(!A.length){return}v.val(A.attr("data-val"));t.current=A.data("kladr-object");v.data("kladr-options",t);p("select",t.current)};var r=function(){var A=b(this);if(A.is("li")){A=A.find("a")}s(A);y();v.focus();return false};var c=function(A){var B=q.find("li.active");switch(A.which){case w.up:if(B.length){B.removeClass("active");B=B.prev()}else{B=q.find("li").last()}B.addClass("active");s();break;case w.down:if(B.length){B.removeClass("active");B=B.next()}else{B=q.find("li").first()}B.addClass("active");s();break;case w.esc:y();break;case w.enter:y();return false}};var f=function(){if(!t.verify){return}var A=u(v.val());if(!b.trim(A)){return}z();p("send");t.source(A,function(C){k();p("received");var D=(C.length>0)?C[0]:false;if(D){var B=A.toLowerCase();var E=D.name.toLowerCase();D=(B==E)?D:false}if(D){v.val(t.valueFormat(D,A))}t.current=D;v.data("kladr-options",t);p("check",t.current)})};var o=function(B){if((B.which>8)&&(B.which<46)){return}var A=u(v.val());if(!b.trim(A)){y();return}z();p("send");t.source(A,function(C){k();p("received");if(!v.is(":focus")){y();return}if(!b.trim(v.val())||!C.length){y();return}g(C,A);x();q.slideDown(50);p("open")})};var y=function(){s();q.hide();p("close")};var j=function(){if(m){return}var A=-0.2;m=setInterval(function(){if(!h.is(":visible")){clearInterval(m);m=null;return}h.css("background-position","0% "+A+"%");A+=5.555556;if(A>95){A=-0.2}},30)};var z=function(){if(t.showSpinner){h.show();j()}};var k=function(){h.hide()};return l(i,n,function(){var A=false;d();x();v.keyup(o);v.keydown(c);v.change(f);v.blur(function(){if(!A){y()}});q.on("click","li, a",r);q.on("mouseenter","li",function(){b(this).addClass("active");A=true});q.on("mouseleave","li",function(){b(this).removeClass("active");A=false});b(window).resize(x)})}})(jQuery);